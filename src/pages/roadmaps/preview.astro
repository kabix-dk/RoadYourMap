---
import Layout from "@/layouts/Layout.astro";
import { RoadmapDisplay } from "@/components/roadmap/RoadmapDisplay";
import type { RoadmapDetailsDto } from "@/types";
import { supabaseAdmin, DEFAULT_USER_ID } from "@/db/supabase.client";

// Fetch the latest roadmap generated by the user
const { data: latestRoadmap, error } = await supabaseAdmin
  .from("roadmaps")
  .select(
    `
    *,
    items:roadmap_items(*)
  `
  )
  .eq("user_id", DEFAULT_USER_ID)
  .order("created_at", { ascending: false })
  .limit(1)
  .single();

if (error) {
  // If we encounter an error or no roadmap exists, redirect to the create page
  return Astro.redirect("/roadmaps/create");
}

// Remove user_id from the response
// eslint-disable-next-line @typescript-eslint/no-unused-vars
const { user_id, ...roadmapData } = latestRoadmap;
---

<Layout title="Preview Roadmap">
  <main class="container mx-auto py-8 px-4">
    <h1 class="text-3xl font-bold mb-8">Preview Generated Roadmap</h1>
    {
      error ? (
        <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded">
          <p>No roadmaps found. Please create a roadmap first.</p>
          <a href="/roadmaps/create" class="text-blue-500 underline mt-2 inline-block">
            Create a Roadmap
          </a>
        </div>
      ) : (
        <RoadmapDisplay client:load roadmapData={roadmapData as RoadmapDetailsDto} />
      )
    }
  </main>
</Layout>
